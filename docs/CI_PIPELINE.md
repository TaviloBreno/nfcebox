# Pipeline de CI Local - NFCeBox

Este documento descreve como configurar e executar um pipeline de Integra√ß√£o Cont√≠nua (CI) local para o projeto NFCeBox, incluindo testes automatizados, an√°lise de c√≥digo e relat√≥rios de cobertura.

## üìã √çndice

1. [Vis√£o Geral](#-vis√£o-geral)
2. [Configura√ß√£o do Ambiente](#-configura√ß√£o-do-ambiente)
3. [Scripts de Automa√ß√£o](#-scripts-de-automa√ß√£o)
4. [Testes Automatizados](#-testes-automatizados)
5. [An√°lise de C√≥digo](#-an√°lise-de-c√≥digo)
6. [Cobertura de C√≥digo](#-cobertura-de-c√≥digo)
7. [Hooks do Git](#-hooks-do-git)
8. [Integra√ß√£o com IDEs](#-integra√ß√£o-com-ides)
9. [Troubleshooting](#-troubleshooting)

## üîç Vis√£o Geral

### Objetivos do Pipeline
- **Qualidade:** Garantir que o c√≥digo atende aos padr√µes de qualidade
- **Confiabilidade:** Executar testes automatizados antes de commits
- **Consist√™ncia:** Manter padr√µes de c√≥digo em toda a equipe
- **Feedback R√°pido:** Identificar problemas rapidamente

### Componentes do Pipeline
1. **An√°lise Est√°tica:** PHPStan, PHP CS Fixer
2. **Testes Unit√°rios:** PHPUnit com cobertura
3. **Testes de Feature:** Testes de integra√ß√£o
4. **Valida√ß√£o de Depend√™ncias:** Composer audit
5. **Formata√ß√£o de C√≥digo:** Padr√µes PSR-12

## ‚öôÔ∏è Configura√ß√£o do Ambiente

### Depend√™ncias Necess√°rias

#### Composer (Desenvolvimento)
```json
{
    "require-dev": {
        "phpunit/phpunit": "^10.0",
        "phpstan/phpstan": "^1.10",
        "friendsofphp/php-cs-fixer": "^3.0",
        "nunomaduro/larastan": "^2.0",
        "pestphp/pest": "^2.0",
        "pestphp/pest-plugin-laravel": "^2.0",
        "spatie/laravel-ignition": "^2.0",
        "fakerphp/faker": "^1.9.1",
        "mockery/mockery": "^1.4.4",
        "nunomaduro/collision": "^7.0"
    }
}
```

#### Instala√ß√£o
```bash
# Instalar depend√™ncias de desenvolvimento
composer install --dev

# Instalar Pest (alternativa ao PHPUnit)
composer require pestphp/pest --dev --with-all-dependencies
./vendor/bin/pest --init
```

### Configura√ß√£o do PHPUnit

#### phpunit.xml
```xml
<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="./vendor/phpunit/phpunit/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         colors="true"
         processIsolation="false"
         stopOnFailure="false"
         cacheDirectory=".phpunit.cache">
    <testsuites>
        <testsuite name="Unit">
            <directory suffix="Test.php">./tests/Unit</directory>
        </testsuite>
        <testsuite name="Feature">
            <directory suffix="Test.php">./tests/Feature</directory>
        </testsuite>
    </testsuites>
    <source>
        <include>
            <directory suffix=".php">./app</directory>
        </include>
        <exclude>
            <directory>./app/Console/Commands</directory>
            <file>./app/Http/Kernel.php</file>
        </exclude>
    </source>
    <php>
        <env name="APP_ENV" value="testing"/>
        <env name="BCRYPT_ROUNDS" value="4"/>
        <env name="CACHE_DRIVER" value="array"/>
        <env name="DB_CONNECTION" value="sqlite"/>
        <env name="DB_DATABASE" value=":memory:"/>
        <env name="MAIL_MAILER" value="array"/>
        <env name="QUEUE_CONNECTION" value="sync"/>
        <env name="SESSION_DRIVER" value="array"/>
        <env name="TELESCOPE_ENABLED" value="false"/>
    </php>
    <coverage>
        <report>
            <html outputDirectory="coverage-report" lowUpperBound="50" highLowerBound="80"/>
            <clover outputFile="coverage.xml"/>
            <text outputFile="coverage.txt"/>
        </report>
    </coverage>
</phpunit>
```

### Configura√ß√£o do PHPStan

#### phpstan.neon
```neon
includes:
    - ./vendor/nunomaduro/larastan/extension.neon

parameters:
    paths:
        - app/
        - database/factories/
        - database/seeders/
    
    level: 8
    
    ignoreErrors:
        - '#PHPDoc tag @var#'
        - '#Call to an undefined method Illuminate\\Database\\Eloquent\\Builder#'
    
    excludePaths:
        - app/Console/Kernel.php
        - app/Http/Kernel.php
        - app/Exceptions/Handler.php
    
    checkMissingIterableValueType: false
    checkGenericClassInNonGenericObjectType: false
    
    tmpDir: storage/phpstan
```

### Configura√ß√£o do PHP CS Fixer

#### .php-cs-fixer.php
```php
<?php

$finder = PhpCsFixer\Finder::create()
    ->in([
        __DIR__ . '/app',
        __DIR__ . '/config',
        __DIR__ . '/database/factories',
        __DIR__ . '/database/seeders',
        __DIR__ . '/routes',
        __DIR__ . '/tests',
    ])
    ->name('*.php')
    ->notName('*.blade.php')
    ->ignoreDotFiles(true)
    ->ignoreVCS(true);

return (new PhpCsFixer\Config())
    ->setRules([
        '@PSR12' => true,
        '@PHP80Migration' => true,
        'array_syntax' => ['syntax' => 'short'],
        'ordered_imports' => ['sort_algorithm' => 'alpha'],
        'no_unused_imports' => true,
        'not_operator_with_successor_space' => true,
        'trailing_comma_in_multiline' => true,
        'phpdoc_scalar' => true,
        'unary_operator_spaces' => true,
        'binary_operator_spaces' => true,
        'blank_line_before_statement' => [
            'statements' => ['break', 'continue', 'declare', 'return', 'throw', 'try'],
        ],
        'phpdoc_single_line_var_spacing' => true,
        'phpdoc_var_without_name' => true,
        'method_argument_space' => [
            'on_multiline' => 'ensure_fully_multiline',
            'keep_multiple_spaces_after_comma' => true,
        ],
    ])
    ->setFinder($finder)
    ->setUsingCache(true)
    ->setCacheFile(__DIR__ . '/.php-cs-fixer.cache');
```

## üöÄ Scripts de Automa√ß√£o

### Composer Scripts

#### composer.json
```json
{
    "scripts": {
        "test": "phpunit",
        "test-coverage": "phpunit --coverage-html coverage-report --coverage-clover coverage.xml",
        "test-unit": "phpunit --testsuite=Unit",
        "test-feature": "phpunit --testsuite=Feature",
        "analyse": "phpstan analyse --memory-limit=2G",
        "format": "php-cs-fixer fix",
        "format-dry": "php-cs-fixer fix --dry-run --diff",
        "ci": [
            "@format-dry",
            "@analyse",
            "@test"
        ],
        "ci-full": [
            "@format-dry",
            "@analyse",
            "@test-coverage",
            "composer audit"
        ],
        "fix": [
            "@format",
            "@analyse",
            "@test"
        ]
    }
}
```

### Scripts PowerShell

#### ci.ps1
```powershell
#!/usr/bin/env pwsh

# Pipeline de CI Local para NFCeBox
# Executa testes, an√°lise de c√≥digo e verifica√ß√µes de qualidade

param(
    [switch]$Coverage,
    [switch]$Fix,
    [switch]$Verbose
)

# Configura√ß√µes
$ErrorActionPreference = "Stop"
$ProgressPreference = "SilentlyContinue"

# Cores para output
function Write-Success { param($Message) Write-Host $Message -ForegroundColor Green }
function Write-Error { param($Message) Write-Host $Message -ForegroundColor Red }
function Write-Warning { param($Message) Write-Host $Message -ForegroundColor Yellow }
function Write-Info { param($Message) Write-Host $Message -ForegroundColor Cyan }

# Banner
Write-Host ""
Write-Host "üöÄ NFCeBox - Pipeline de CI Local" -ForegroundColor Magenta
Write-Host "======================================" -ForegroundColor Magenta
Write-Host ""

# Verificar depend√™ncias
Write-Info "üì¶ Verificando depend√™ncias..."
try {
    if (!(Test-Path "vendor/autoload.php")) {
        Write-Warning "Depend√™ncias n√£o encontradas. Instalando..."
        composer install --no-interaction --prefer-dist --optimize-autoloader
    }
    Write-Success "‚úì Depend√™ncias OK"
} catch {
    Write-Error "‚úó Erro ao verificar depend√™ncias: $_"
    exit 1
}

# Preparar ambiente de teste
Write-Info "üîß Preparando ambiente de teste..."
try {
    if (!(Test-Path ".env.testing")) {
        Copy-Item ".env.example" ".env.testing"
        (Get-Content ".env.testing") -replace "APP_ENV=local", "APP_ENV=testing" | Set-Content ".env.testing"
        (Get-Content ".env.testing") -replace "DB_CONNECTION=mysql", "DB_CONNECTION=sqlite" | Set-Content ".env.testing"
        (Get-Content ".env.testing") -replace "DB_DATABASE=nfcebox", "DB_DATABASE=:memory:" | Set-Content ".env.testing"
    }
    
    # Limpar cache
    php artisan config:clear --env=testing
    php artisan cache:clear --env=testing
    
    Write-Success "‚úì Ambiente preparado"
} catch {
    Write-Error "‚úó Erro ao preparar ambiente: $_"
    exit 1
}

# An√°lise de c√≥digo est√°tico
Write-Info "üîç Executando an√°lise est√°tica (PHPStan)..."
try {
    $phpstanOutput = php ./vendor/bin/phpstan analyse --memory-limit=2G --no-progress 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Success "‚úì An√°lise est√°tica passou"
        if ($Verbose) { Write-Host $phpstanOutput }
    } else {
        Write-Error "‚úó An√°lise est√°tica falhou"
        Write-Host $phpstanOutput
        exit 1
    }
} catch {
    Write-Error "‚úó Erro na an√°lise est√°tica: $_"
    exit 1
}

# Verifica√ß√£o de formata√ß√£o
Write-Info "üìù Verificando formata√ß√£o de c√≥digo..."
try {
    $fixerOutput = php ./vendor/bin/php-cs-fixer fix --dry-run --diff --no-interaction 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Success "‚úì Formata√ß√£o OK"
        if ($Verbose) { Write-Host $fixerOutput }
    } else {
        Write-Warning "‚ö† Problemas de formata√ß√£o encontrados"
        Write-Host $fixerOutput
        
        if ($Fix) {
            Write-Info "üîß Corrigindo formata√ß√£o..."
            php ./vendor/bin/php-cs-fixer fix --no-interaction
            Write-Success "‚úì Formata√ß√£o corrigida"
        } else {
            Write-Warning "Use -Fix para corrigir automaticamente"
        }
    }
} catch {
    Write-Error "‚úó Erro na verifica√ß√£o de formata√ß√£o: $_"
    exit 1
}

# Testes unit√°rios
Write-Info "üß™ Executando testes unit√°rios..."
try {
    $testCommand = "php ./vendor/bin/phpunit --testsuite=Unit --no-coverage"
    if ($Verbose) { $testCommand += " --verbose" }
    
    $testOutput = Invoke-Expression $testCommand 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Success "‚úì Testes unit√°rios passaram"
        if ($Verbose) { Write-Host $testOutput }
    } else {
        Write-Error "‚úó Testes unit√°rios falharam"
        Write-Host $testOutput
        exit 1
    }
} catch {
    Write-Error "‚úó Erro nos testes unit√°rios: $_"
    exit 1
}

# Testes de feature
Write-Info "üéØ Executando testes de feature..."
try {
    $testCommand = "php ./vendor/bin/phpunit --testsuite=Feature --no-coverage"
    if ($Verbose) { $testCommand += " --verbose" }
    
    $testOutput = Invoke-Expression $testCommand 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Success "‚úì Testes de feature passaram"
        if ($Verbose) { Write-Host $testOutput }
    } else {
        Write-Error "‚úó Testes de feature falharam"
        Write-Host $testOutput
        exit 1
    }
} catch {
    Write-Error "‚úó Erro nos testes de feature: $_"
    exit 1
}

# Cobertura de c√≥digo (opcional)
if ($Coverage) {
    Write-Info "üìä Gerando relat√≥rio de cobertura..."
    try {
        php ./vendor/bin/phpunit --coverage-html coverage-report --coverage-clover coverage.xml --coverage-text
        Write-Success "‚úì Relat√≥rio de cobertura gerado em coverage-report/"
    } catch {
        Write-Warning "‚ö† Erro ao gerar cobertura: $_"
    }
}

# Auditoria de seguran√ßa
Write-Info "üîí Executando auditoria de seguran√ßa..."
try {
    $auditOutput = composer audit --format=plain 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Success "‚úì Auditoria de seguran√ßa passou"
        if ($Verbose) { Write-Host $auditOutput }
    } else {
        Write-Warning "‚ö† Vulnerabilidades encontradas"
        Write-Host $auditOutput
    }
} catch {
    Write-Warning "‚ö† Erro na auditoria: $_"
}

# Resumo final
Write-Host ""
Write-Success "üéâ Pipeline de CI conclu√≠do com sucesso!"
Write-Host ""
Write-Info "üìã Resumo:"
Write-Host "   ‚úì An√°lise est√°tica (PHPStan)"
Write-Host "   ‚úì Formata√ß√£o de c√≥digo (PHP CS Fixer)"
Write-Host "   ‚úì Testes unit√°rios"
Write-Host "   ‚úì Testes de feature"
if ($Coverage) { Write-Host "   ‚úì Relat√≥rio de cobertura" }
Write-Host "   ‚úì Auditoria de seguran√ßa"
Write-Host ""
```

#### test.ps1
```powershell
#!/usr/bin/env pwsh

# Script simplificado para executar apenas testes

param(
    [string]$Suite = "all",
    [switch]$Coverage,
    [switch]$Verbose
)

$ErrorActionPreference = "Stop"

Write-Host "üß™ Executando testes - NFCeBox" -ForegroundColor Cyan
Write-Host "================================" -ForegroundColor Cyan

# Preparar ambiente
if (!(Test-Path ".env.testing")) {
    Copy-Item ".env.example" ".env.testing"
    (Get-Content ".env.testing") -replace "APP_ENV=local", "APP_ENV=testing" | Set-Content ".env.testing"
    (Get-Content ".env.testing") -replace "DB_CONNECTION=mysql", "DB_CONNECTION=sqlite" | Set-Content ".env.testing"
    (Get-Content ".env.testing") -replace "DB_DATABASE=nfcebox", "DB_DATABASE=:memory:" | Set-Content ".env.testing"
}

# Construir comando
$command = "php ./vendor/bin/phpunit"

switch ($Suite.ToLower()) {
    "unit" { $command += " --testsuite=Unit" }
    "feature" { $command += " --testsuite=Feature" }
    "all" { }
    default { $command += " --testsuite=$Suite" }
}

if ($Coverage) {
    $command += " --coverage-html coverage-report --coverage-clover coverage.xml"
} else {
    $command += " --no-coverage"
}

if ($Verbose) {
    $command += " --verbose"
}

# Executar testes
try {
    Invoke-Expression $command
    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ Testes conclu√≠dos com sucesso!" -ForegroundColor Green
    } else {
        Write-Host "‚ùå Alguns testes falharam!" -ForegroundColor Red
        exit 1
    }
} catch {
    Write-Host "‚ùå Erro ao executar testes: $_" -ForegroundColor Red
    exit 1
}
```

## üß™ Testes Automatizados

### Estrutura de Testes

```
tests/
‚îú‚îÄ‚îÄ Feature/
‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoginTest.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RegistrationTest.php
‚îÇ   ‚îú‚îÄ‚îÄ Sales/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SaleControllerTest.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SaleCreationTest.php
‚îÇ   ‚îú‚îÄ‚îÄ Products/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProductControllerTest.php
‚îÇ   ‚îî‚îÄ‚îÄ Reports/
‚îÇ       ‚îî‚îÄ‚îÄ ReportGenerationTest.php
‚îú‚îÄ‚îÄ Unit/
‚îÇ   ‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SaleTest.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductTest.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CustomerTest.php
‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NfceBuilderServiceTest.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ XmlBuilderServiceTest.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SefazClientServiceTest.php
‚îÇ   ‚îî‚îÄ‚îÄ Helpers/
‚îÇ       ‚îî‚îÄ‚îÄ FormattersTest.php
‚îú‚îÄ‚îÄ TestCase.php
‚îî‚îÄ‚îÄ CreatesApplication.php
```

### Configura√ß√£o Base de Testes

#### tests/TestCase.php
```php
<?php

namespace Tests;

use Illuminate\Foundation\Testing\TestCase as BaseTestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Artisan;

abstract class TestCase extends BaseTestCase
{
    use CreatesApplication, RefreshDatabase;
    
    protected function setUp(): void
    {
        parent::setUp();
        
        // Configurar ambiente de teste
        config(['app.env' => 'testing']);
        config(['database.default' => 'sqlite']);
        config(['database.connections.sqlite.database' => ':memory:']);
        
        // Executar migrations
        Artisan::call('migrate:fresh');
        
        // Seed b√°sico para testes
        $this->seed(\Database\Seeders\TestScenarioSeeder::class);
    }
    
    protected function tearDown(): void
    {
        // Limpar arquivos tempor√°rios
        $this->cleanupTempFiles();
        
        parent::tearDown();
    }
    
    protected function cleanupTempFiles(): void
    {
        $tempDirs = [
            storage_path('app/temp'),
            storage_path('app/xml'),
            storage_path('app/pdf'),
        ];
        
        foreach ($tempDirs as $dir) {
            if (is_dir($dir)) {
                array_map('unlink', glob("$dir/*"));
            }
        }
    }
    
    protected function createAuthenticatedUser($role = 'operator')
    {
        $user = \App\Models\User::factory()->create(['role' => $role]);
        $this->actingAs($user);
        
        return $user;
    }
}
```

### Exemplo de Teste de Feature

#### tests/Feature/Sales/SaleCreationTest.php
```php
<?php

namespace Tests\Feature\Sales;

use Tests\TestCase;
use App\Models\User;
use App\Models\Product;
use App\Models\Customer;
use Illuminate\Foundation\Testing\RefreshDatabase;

class SaleCreationTest extends TestCase
{
    use RefreshDatabase;
    
    public function test_authenticated_user_can_create_sale()
    {
        // Arrange
        $user = $this->createAuthenticatedUser('operator');
        $product = Product::factory()->create(['stock' => 10, 'price' => 25.50]);
        $customer = Customer::factory()->create();
        
        $saleData = [
            'customer_id' => $customer->id,
            'payment_method' => 'credit_card',
            'items' => [
                [
                    'product_id' => $product->id,
                    'quantity' => 2,
                    'unit_price' => 25.50
                ]
            ]
        ];
        
        // Act
        $response = $this->postJson('/api/sales', $saleData);
        
        // Assert
        $response->assertStatus(201)
                ->assertJsonStructure([
                    'data' => [
                        'id',
                        'customer_id',
                        'total',
                        'status',
                        'items'
                    ]
                ]);
        
        $this->assertDatabaseHas('sales', [
            'customer_id' => $customer->id,
            'user_id' => $user->id,
            'total' => 51.00,
            'status' => 'completed'
        ]);
        
        // Verificar redu√ß√£o do estoque
        $product->refresh();
        $this->assertEquals(8, $product->stock);
    }
    
    public function test_sale_creation_fails_with_insufficient_stock()
    {
        // Arrange
        $this->createAuthenticatedUser('operator');
        $product = Product::factory()->create(['stock' => 1]);
        $customer = Customer::factory()->create();
        
        $saleData = [
            'customer_id' => $customer->id,
            'payment_method' => 'cash',
            'items' => [
                [
                    'product_id' => $product->id,
                    'quantity' => 5, // Mais que o estoque dispon√≠vel
                    'unit_price' => 10.00
                ]
            ]
        ];
        
        // Act
        $response = $this->postJson('/api/sales', $saleData);
        
        // Assert
        $response->assertStatus(422)
                ->assertJsonValidationErrors(['items.0.quantity']);
        
        $this->assertDatabaseMissing('sales', [
            'customer_id' => $customer->id
        ]);
        
        // Verificar que o estoque n√£o foi alterado
        $product->refresh();
        $this->assertEquals(1, $product->stock);
    }
}
```

### Exemplo de Teste Unit√°rio

#### tests/Unit/Services/NfceBuilderServiceTest.php
```php
<?php

namespace Tests\Unit\Services;

use Tests\TestCase;
use App\Services\NfceBuilderService;
use App\Models\Sale;
use App\Models\CompanyConfig;
use Mockery;

class NfceBuilderServiceTest extends TestCase
{
    protected NfceBuilderService $service;
    
    protected function setUp(): void
    {
        parent::setUp();
        $this->service = app(NfceBuilderService::class);
    }
    
    public function test_can_build_nfce_xml_structure()
    {
        // Arrange
        $sale = Sale::factory()->withItems(2)->create();
        $company = CompanyConfig::factory()->create();
        
        // Act
        $xml = $this->service->buildXml($sale);
        
        // Assert
        $this->assertIsString($xml);
        $this->assertStringContainsString('<?xml version="1.0" encoding="UTF-8"?>', $xml);
        $this->assertStringContainsString('<NFCe>', $xml);
        $this->assertStringContainsString('<infNFe>', $xml);
        $this->assertStringContainsString($company->cnpj, $xml);
        $this->assertStringContainsString($sale->total, $xml);
    }
    
    public function test_xml_contains_all_required_fields()
    {
        // Arrange
        $sale = Sale::factory()->withItems(1)->create();
        
        // Act
        $xml = $this->service->buildXml($sale);
        $xmlObject = simplexml_load_string($xml);
        
        // Assert - Verificar campos obrigat√≥rios
        $this->assertNotNull($xmlObject->infNFe->ide->cNF);
        $this->assertNotNull($xmlObject->infNFe->ide->natOp);
        $this->assertNotNull($xmlObject->infNFe->ide->mod);
        $this->assertNotNull($xmlObject->infNFe->ide->serie);
        $this->assertNotNull($xmlObject->infNFe->ide->nNF);
        $this->assertNotNull($xmlObject->infNFe->ide->dhEmi);
        $this->assertNotNull($xmlObject->infNFe->ide->tpNF);
        $this->assertNotNull($xmlObject->infNFe->ide->idDest);
        $this->assertNotNull($xmlObject->infNFe->ide->cMunFG);
        $this->assertNotNull($xmlObject->infNFe->ide->tpImp);
        $this->assertNotNull($xmlObject->infNFe->ide->tpEmis);
        $this->assertNotNull($xmlObject->infNFe->ide->tpAmb);
    }
    
    public function test_throws_exception_for_invalid_sale()
    {
        // Arrange
        $sale = Sale::factory()->create(['total' => 0]);
        
        // Act & Assert
        $this->expectException(\InvalidArgumentException::class);
        $this->expectExceptionMessage('Venda inv√°lida para gera√ß√£o de NFCe');
        
        $this->service->buildXml($sale);
    }
}
```

## üìä Cobertura de C√≥digo

### Configura√ß√£o do Xdebug

#### php.ini (desenvolvimento)
```ini
[xdebug]
zend_extension=xdebug
xdebug.mode=coverage,debug
xdebug.start_with_request=yes
xdebug.client_host=127.0.0.1
xdebug.client_port=9003
xdebug.log_level=0
```

### Relat√≥rios de Cobertura

#### Gerar Relat√≥rio HTML
```bash
# Relat√≥rio completo
php ./vendor/bin/phpunit --coverage-html coverage-report

# Apenas texto
php ./vendor/bin/phpunit --coverage-text

# XML para integra√ß√£o
php ./vendor/bin/phpunit --coverage-clover coverage.xml
```

#### Script de An√°lise de Cobertura
```powershell
# coverage-analysis.ps1

param(
    [int]$MinCoverage = 80
)

# Executar testes com cobertura
php ./vendor/bin/phpunit --coverage-clover coverage.xml --coverage-text > coverage.txt

# Extrair percentual de cobertura
$coverageText = Get-Content coverage.txt
$coverageLine = $coverageText | Select-String "Lines:\s+(\d+\.\d+)%"

if ($coverageLine) {
    $coverage = [float]$coverageLine.Matches[0].Groups[1].Value
    
    Write-Host "üìä Cobertura de c√≥digo: $coverage%" -ForegroundColor Cyan
    
    if ($coverage -ge $MinCoverage) {
        Write-Host "‚úÖ Cobertura adequada (>= $MinCoverage%)" -ForegroundColor Green
        exit 0
    } else {
        Write-Host "‚ùå Cobertura insuficiente (< $MinCoverage%)" -ForegroundColor Red
        exit 1
    }
} else {
    Write-Host "‚ö†Ô∏è N√£o foi poss√≠vel determinar a cobertura" -ForegroundColor Yellow
    exit 1
}
```

## üîó Hooks do Git

### Pre-commit Hook

#### .git/hooks/pre-commit
```bash
#!/bin/sh

# Pre-commit hook para NFCeBox
# Executa verifica√ß√µes b√°sicas antes do commit

echo "üîç Executando verifica√ß√µes pre-commit..."

# Verificar se h√° arquivos PHP modificados
php_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$')

if [ -z "$php_files" ]; then
    echo "‚úÖ Nenhum arquivo PHP modificado"
    exit 0
fi

echo "üìù Verificando formata√ß√£o de c√≥digo..."
# Verificar formata√ß√£o apenas dos arquivos modificados
for file in $php_files; do
    if [ -f "$file" ]; then
        ./vendor/bin/php-cs-fixer fix "$file" --dry-run --diff > /dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo "‚ùå Problemas de formata√ß√£o em: $file"
            echo "Execute: ./vendor/bin/php-cs-fixer fix $file"
            exit 1
        fi
    fi
done

echo "üîç Executando an√°lise est√°tica..."
# An√°lise est√°tica apenas dos arquivos modificados
for file in $php_files; do
    if [ -f "$file" ]; then
        ./vendor/bin/phpstan analyse "$file" --no-progress > /dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo "‚ùå Problemas na an√°lise est√°tica em: $file"
            echo "Execute: ./vendor/bin/phpstan analyse $file"
            exit 1
        fi
    fi
done

echo "üß™ Executando testes r√°pidos..."
# Executar apenas testes unit√°rios (mais r√°pidos)
./vendor/bin/phpunit --testsuite=Unit --no-coverage > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "‚ùå Testes unit√°rios falharam"
    echo "Execute: composer test-unit"
    exit 1
fi

echo "‚úÖ Todas as verifica√ß√µes passaram!"
exit 0
```

### Pre-push Hook

#### .git/hooks/pre-push
```bash
#!/bin/sh

# Pre-push hook para NFCeBox
# Executa pipeline completo antes do push

echo "üöÄ Executando pipeline completo antes do push..."

# Executar pipeline de CI
if command -v pwsh > /dev/null 2>&1; then
    pwsh -File ci.ps1
else
    composer ci
fi

if [ $? -ne 0 ]; then
    echo "‚ùå Pipeline falhou. Push cancelado."
    exit 1
fi

echo "‚úÖ Pipeline passou. Prosseguindo com push..."
exit 0
```

### Instala√ß√£o dos Hooks

#### install-hooks.ps1
```powershell
#!/usr/bin/env pwsh

# Script para instalar hooks do Git

Write-Host "üîó Instalando hooks do Git..." -ForegroundColor Cyan

# Verificar se estamos em um reposit√≥rio Git
if (!(Test-Path ".git")) {
    Write-Error "‚ùå N√£o √© um reposit√≥rio Git"
    exit 1
}

# Criar diret√≥rio de hooks se n√£o existir
if (!(Test-Path ".git/hooks")) {
    New-Item -ItemType Directory -Path ".git/hooks" -Force
}

# Copiar hooks
$hooks = @(
    "pre-commit",
    "pre-push"
)

foreach ($hook in $hooks) {
    $sourcePath = "scripts/git-hooks/$hook"
    $targetPath = ".git/hooks/$hook"
    
    if (Test-Path $sourcePath) {
        Copy-Item $sourcePath $targetPath -Force
        
        # Tornar execut√°vel (no Linux/Mac)
        if ($IsLinux -or $IsMacOS) {
            chmod +x $targetPath
        }
        
        Write-Host "‚úÖ Hook $hook instalado" -ForegroundColor Green
    } else {
        Write-Warning "‚ö†Ô∏è Hook $hook n√£o encontrado em $sourcePath"
    }
}

Write-Host "üéâ Hooks instalados com sucesso!" -ForegroundColor Green
Write-Host "Os hooks ser√£o executados automaticamente nos commits e pushes." -ForegroundColor Yellow
```

## üîß Troubleshooting

### Problemas Comuns

#### 1. Testes Falhando

**Sintomas:**
- Testes passam localmente mas falham no CI
- Erros de conex√£o com banco
- Timeouts em testes

**Solu√ß√µes:**
```bash
# Limpar cache de configura√ß√£o
php artisan config:clear --env=testing
php artisan cache:clear --env=testing

# Verificar configura√ß√£o de teste
php artisan config:show database --env=testing

# Executar migrations manualmente
php artisan migrate:fresh --env=testing
```

#### 2. Cobertura de C√≥digo N√£o Funciona

**Verificar Xdebug:**
```bash
# Verificar se Xdebug est√° instalado
php -m | grep xdebug

# Verificar configura√ß√£o
php -i | grep xdebug.mode

# Instalar Xdebug (se necess√°rio)
# Windows com XAMPP: j√° inclu√≠do
# Linux: sudo apt-get install php-xdebug
# Mac: brew install php@8.1-xdebug
```

#### 3. PHPStan Muito Lento

**Otimiza√ß√µes:**
```bash
# Usar cache
mkdir -p storage/phpstan

# Aumentar mem√≥ria
php -d memory_limit=2G ./vendor/bin/phpstan analyse

# Analisar apenas arquivos modificados
git diff --name-only | grep '\.php$' | xargs ./vendor/bin/phpstan analyse
```

#### 4. PHP CS Fixer Conflitos

**Resolver conflitos:**
```bash
# Ver diferen√ßas
./vendor/bin/php-cs-fixer fix --dry-run --diff

# Aplicar corre√ß√µes
./vendor/bin/php-cs-fixer fix

# Ignorar arquivos espec√≠ficos
echo "storage/" >> .php-cs-fixer.ignore
echo "bootstrap/cache/" >> .php-cs-fixer.ignore
```

### Scripts de Diagn√≥stico

#### diagnose.ps1
```powershell
#!/usr/bin/env pwsh

# Script de diagn√≥stico do ambiente de CI

Write-Host "üîç Diagn√≥stico do Ambiente de CI" -ForegroundColor Magenta
Write-Host "================================" -ForegroundColor Magenta

# Verificar PHP
Write-Host "\nüìã Vers√£o do PHP:" -ForegroundColor Cyan
php --version

# Verificar extens√µes
Write-Host "\nüîå Extens√µes PHP importantes:" -ForegroundColor Cyan
$extensions = @('xdebug', 'sqlite3', 'mbstring', 'xml', 'curl', 'zip')
foreach ($ext in $extensions) {
    $result = php -m | Select-String $ext
    if ($result) {
        Write-Host "  ‚úÖ $ext" -ForegroundColor Green
    } else {
        Write-Host "  ‚ùå $ext" -ForegroundColor Red
    }
}

# Verificar Composer
Write-Host "\nüì¶ Composer:" -ForegroundColor Cyan
composer --version

# Verificar depend√™ncias
Write-Host "\nüîç Depend√™ncias de desenvolvimento:" -ForegroundColor Cyan
$devDeps = @('phpunit/phpunit', 'phpstan/phpstan', 'friendsofphp/php-cs-fixer')
foreach ($dep in $devDeps) {
    if (Test-Path "vendor/$dep") {
        Write-Host "  ‚úÖ $dep" -ForegroundColor Green
    } else {
        Write-Host "  ‚ùå $dep" -ForegroundColor Red
    }
}

# Verificar configura√ß√µes
Write-Host "\n‚öôÔ∏è Configura√ß√µes:" -ForegroundColor Cyan
Write-Host "  phpunit.xml: $(if (Test-Path 'phpunit.xml') { '‚úÖ' } else { '‚ùå' })"
Write-Host "  phpstan.neon: $(if (Test-Path 'phpstan.neon') { '‚úÖ' } else { '‚ùå' })"
Write-Host "  .php-cs-fixer.php: $(if (Test-Path '.php-cs-fixer.php') { '‚úÖ' } else { '‚ùå' })"
Write-Host "  .env.testing: $(if (Test-Path '.env.testing') { '‚úÖ' } else { '‚ùå' })"

# Verificar permiss√µes
Write-Host "\nüìÅ Diret√≥rios:" -ForegroundColor Cyan
$dirs = @('storage/logs', 'storage/framework/cache', 'storage/framework/sessions', 'storage/framework/views')
foreach ($dir in $dirs) {
    if (Test-Path $dir) {
        Write-Host "  ‚úÖ $dir" -ForegroundColor Green
    } else {
        Write-Host "  ‚ùå $dir (criando...)" -ForegroundColor Yellow
        New-Item -ItemType Directory -Path $dir -Force -ErrorAction SilentlyContinue
    }
}

Write-Host "\nüéâ Diagn√≥stico conclu√≠do!" -ForegroundColor Green
```

## üìö Refer√™ncias

### Documenta√ß√£o
- [PHPUnit Documentation](https://phpunit.de/documentation.html)
- [PHPStan Documentation](https://phpstan.org/user-guide/getting-started)
- [PHP CS Fixer Documentation](https://cs.symfony.com/)
- [Laravel Testing](https://laravel.com/docs/testing)

### Ferramentas Adicionais
- [Pest PHP](https://pestphp.com/) - Alternativa moderna ao PHPUnit
- [Larastan](https://github.com/nunomaduro/larastan) - PHPStan para Laravel
- [PHP Insights](https://phpinsights.com/) - An√°lise de qualidade de c√≥digo
- [Rector](https://getrector.org/) - Refatora√ß√£o autom√°tica de c√≥digo

### Integra√ß√£o com IDEs
- **VS Code:** PHP Intelephense, PHPUnit Test Explorer
- **PhpStorm:** Suporte nativo para PHPUnit, PHPStan e PHP CS Fixer
- **Sublime Text:** LSP-phpstan, SublimeLinter-phpcs